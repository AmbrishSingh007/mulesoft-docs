= For Each Scope

The For Each scope (`foreach`) splits a payload into elements and processes them one by one through the components that you place in the scope. It is similar to a for-each/for-loop code block in most programming languages.

It can process any a collection, including lists, arrays. The collection can be any supported content type, such as `application/json`, `application/java`, `application/xml`.

////
TODO? Splitter not in Studio 7 as of GA. Not clear when it will be in.
== Differences With a Splitter

The For Each scope performs a similar task to using a Splitter and then an Aggregator. The main difference is that the For Each scope outputs a collection just like the one it receives, the Aggregator outputs a message where the payload is a list of mule messages (each with its own payload and attributes).
////

* By default the foreach will try to split the payload. If the payload is a simple Java collection, the For Each scope can split it without any configuration.
* Foreach will not modify the current payload.
* For non-Java colletions, such as XML or JSON, you need to use a DateWeave expression to split data. You use the Collection (`collection`) field for this purpose.
+
Here, the Collection field in For Each is set to iterate over an array stored in `payload.topics`.
+
image::component-foreach-example.png[For Each Component]


////
Note that if the input contains information outside the collection you tell it to split, this information is lost.
////

You can also split an array in batches. Potentially, these batches promote quicker processing. Each batch is treated as a separate Mule message. For example, if a collection has 200 elements and you set Batch Size (`batchSize`) to `50`, the For Each scope iteratively processes 4 batches of 50 elements, each as a separate Mule message.

== Error Handling

If one of the elements in a collection throws an exception, the For Each scope stops processing that collection and invokes the error handler.


== Examples

=== Iterate a json array

[source,xml,linenums]
----
include::_sources/for-each-scope-concept_1.xml[]
----

In this case the payload contains a json array and since the foreach will iterate over the payload since the collection attribute has not been defined. The payload within the foreach is each of the users of the json array.

=== Iterate over a java Map placed in a variable

[source,xml,linenums]
----
include::_sources/for-each-scope-concept_2.xml[]
----

We use the `ee:transform` to set a variables named `users` with a java map created with DataWeave. Then we use a built-in function of DataWeave to get the entries of a map as a collection so we can iterate over it.

=== Split a collection into batches

[source,xml,linenums]
----
include::_sources/for-each-scope-concept_3.xml[]
----

The `batchSize` attribute allow us to create sub-arrays of two elements. So inside the `foreach` the payload will have an array of two elements.

=== Aggregate the process of each element into a variable

[source,xml,linenums]
----
include::_sources/for-each-scope-concept_4.xml[]
----

Within the foreach we create an `aggregation` variable with the concatenaton of the reverse name. Then that variable can be accessed outside the foreach scope.

////
EDGE CASE? OUT IN 4.0, PER DAN F. IF THERE'S A REQUEST TO RESTORE IT, WE MIGHT RESTORE IT
== Persisting Data

In case the message inside the For Each scope is persisted, not only the item in the collection is serialized but also all the variables associated with it. The rootMessage variable, associated with the message, contains a reference to the complete, unsplit collection. Therefore, serialization/deserialization of the rootMessage variable could impact memory consumption considerably when this collection is large enough.

To avoid this issue you must first remove the rootMessage variable from the message before persisting it.
////

== See Also

* link:/mule-user-guide/v/4.0/for-each-scope-xml-reference[For Each Scope XML Reference]
* link:/mule-user-guide/v/4.0/scopes-concept[About Scopes]
* link:/mule-user-guide/v/4.0/about-mule-event[About the Mule Event]
* link:/mule-user-guide/v/4.0/about-mule-message[About the Mule Message]
