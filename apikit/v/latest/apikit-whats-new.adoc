= What's New in APIkit

*For the latest docs, see https://beta-apikit4.docs-stgx.mulesoft.com/*

If you're an APIkit 3.x user, you can get up and running quickly with APIkit 4.0. Basic use hasn't changed. Key improvements and changes in this release are:

* APIkit is now a Mule plugin. 
+
** MuleSoft can update APIkit in a timely manner, independent from Mule Runtime updates.
** To use a different APIkit version, just change the dependency in the POM.
+
* API Console 4.0 that simulates calls to the API is not embedded in Studio.
* Some APIkit XML elements and attributes changed. The Mule project structure changed.
* Error handling aligns with Mule Runtime 4.0.

== APIkit Distribution

In Studio, you use the installation wizard to check for updates. The timing of future improvements and fixes are no longer constrained by Studio or Mule Runtime release schedules.

To change an APIkit version, just change the dependency in the POM of your application with the latest version of the module.

[source,xml,linenums]
----
<dependency>
    <groupId>org.mule.modules</groupId>
    <artifactId>mule-apikit-module</artifactId>
    <version>1.0.0-ea</version>
    <classifier>mule-plugin</classifier>
</dependency>
----

== Handling Errors

APIkit 4.0 replaces exception strategy and error mapping with the Mule Runtime 4.0 error handler. This error handler uses error types as shown in the code snippet below. Each error response is generated using DataWeave.

[source,xml,linenums]
----
<apikit:router config-ref="api-config" />
<error-handler>
    <on-error-propagate type="APIKIT:BAD_REQUEST">
        <ee:transform xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
            <ee:message>
                <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{message: "Bad request"}]]></ee:set-payload>
            </ee:message>
            <ee:variables>
                <ee:set-variable variableName="httpStatus">400</ee:set-variable>
            </ee:variables>
        </ee:transform>
    </on-error-propagate>
</error-handler>    
----

== Customizing the API Console URL

Open a browser, and go to `/console` to use the mocking server and simulate calls to the API. In API Console, you can customize the URL for exposing the API.

[source,xml,linenums]
----
<flow name="main-console">
    <http:listener config-ref="httpListenerConfigDefault" path="/console/*">
        <http:response statusCode="#[variables.httpStatus default 200]">
            <http:headers>#[variables.outboundHeaders default {}]</http:headers>
        </http:response>
        <http:error-response statusCode="#[variables.httpStatus default 500]">
            <http:body>#[payload]</http:body>
            <http:headers>#[variables.outboundHeaders default {}]</http:headers>
        </http:error-response>
    </http:listener>
    <apikit:console config-ref="router-config" />
</flow>
----


You can also change the host, port, path, and scheme by editing the listener and listener-config.

== Configuring APIkit

In the HTTP Listener, you can configure a verbose form of the response HTTP headers and status code. You configure two properties:

* `outboundHeadersMapName`
+
Supports sending custom headers with the response.
+
* `httpStatusVarName`
+
Supports sending a custom HTTP status code in the response.

=== Removal of Deprecated Properties

This release removes the following APIkit properties:

* `consolePath`
* `consoleEnabled`

== APIkit Project Structure

The API folder is located under resources. API definition files are no longer duplicated in the root folder.

image::api-folder.png[api folder]

== Executing Non-functional Requirements after the Router

By defining any message processor, you can execute non-functional requirements or quality attributes after the Router. You can add logs or traceability for all flows in one place.

== Adding a Header to a Response

Put the header you want to add inside the `outboundHeaders` map, as shown in the following example:

[source,xml,linenums]
----
<ee:transform>
    <ee:set-variables>
    <ee:set-variable name="outboundHeaders">
        variables.outboundHeaders ++{headerName:"value"}
    </ee:set-variable>
</ee:set-variables>
</ee:transform>
----

== Auto-generated Response (Enterprise Edition)

APIkit uses DataWeave for generating a mocked implementation based on the examples provided in a RAML definition.

== Validating Headers and Query Parameters

You can now configure APIkit Router to enable and disable validation of headers and query parameters. 

image::validation-configuration.png[]

You set the following options to enable or disable validations:

* Query parameters strict validations
+
Check the option to allow only query parameters defined in the RAML.
+
* Headers strict validations
+
Check the option to limit headers to those defined in the RAML

== See Also

* link:/mule-user-guide/v/4.0/error-handling[Error Handling Reference]
* link:/apikit/apikit-simulate[To Simulate API Calls using API Console]
* link:/apikit/apikit-validate-task[To Validate Query Parameters and Headers]
