// Andres Alleva
= Example: Migration to Mule 4

////
This example migrates a Mule app to Mule 4 from Mule 3.
// Writer: Please explain the features or use cases you are going
// to cover. Provide a rationale, explaining how they worked
// in Mule 3 vs. how they work in Mule 4.

// You might list features in Mule 3 that you migrate to Mule 4,
// naming each feature, explaining how things changed in Mule 4,
// and anything about how it will work once migrated.

// * Feature 1
// * Feature 2
// * Feature etc.

// Before and After description: Please provide the big picture of what
// the app you are migrating looks like. Screenshots from in Studio 6 vs. // Studio 7 might be the most straightforward way to illustrate this.

//Optional: screenshot to store in migration/v/latest/_images
Here is a screenshot of this Mule app in Studio 6:

image::example1_complex_screenshot_here.png[App in Mule 3]

// Highlight the main differences between the examples.

//Optional: screenshot to store in migration/v/latest/_images
Here is the migrated app in Studio 7:

image::example2_complex_screenshot_here.png[App in Mule 4]

// If necessary or helpful, break down the migration into major steps,
// including any prep, for example:

This migration follows these basic steps:

. step 1
. step 2
. etc.

// Break down the app migration on a feature-by-feature basis.
////

== Migrating Property Placeholders

// Please replace this comment with an explanation
// of how you migrated the feature, and show the Studio 6
// vs. Studio 7 XML for the feature. Please provide any
// extra info needed to understand the changes to this feature
// in Mule 3 and Mule 4.
Mule 4 supports property placeholders either as `.yaml` or `.properties` configuration files.

. Create a folder with the name `config` under `/src/main/resources` project directory.
. Create a configuration file with the name `configuration.yaml` inside the newly created config folder.
. Migrate property placeholders from `.properties` to `.yaml` format.
+
.configuration.properties
----
http.host=0.0.0.0
http.port=8081

mysql.password=pa$$w0rd
mysql.port=3306
mysql.user=admin
mysql.database=products
mysql.host=corp.services.com

autodiscovery.api.version=1.0.0:1762946
autodiscovery.api.name=groupId:com.mulesoft.retailer.manufacturingit.apis:assetId:product-api-database

anypoint.platform.client_id=1f702j71hu9z2x88v9vd19v7h248s589
anypoint.platform.client_secret=87v8V47668701Dd574B0531255d6287d
----
+
.configuration.yaml
----
http:
  host: "0.0.0.0"
  port: "8081"

mysql:
  password: "pa$$w0rd"
  port: "3306"
  user: "admin"
  database: "products"
  host: "corp.services.com"

autodiscovery:
  api:
    name: "groupId:com.mulesoft.retailer.manufacturingit.apis:assetId:product-api-database"
    version: "1.0.0:1762946"

anypoint:
  platform:
    client_id: "1f702j71hu9z2x88v9vd19v7h248s589"
    client_secret: "87v8V47668701Dd574B0531255d6287d"
----
+
. Replace the standard Spring element `<context:property-placeholder>` with the new Global Element `configuration-properties`.
+
.Configuration XML for Property Placeholders in Studio 6.
[source,xml,linenums]
----
<context:property-placeholder location="configuration.properties" />
----
+
// Explain what changed for Mule 4 in Studio 7, including any different modules, component you needed to use.
The `file` attribute points to the new configuration file in YAML format located under `/src/main/resources/config` folder.
+
.Configuration XML for Property Placeholders in Studio 7.
[source,xml,linenums]
----
<configuration-properties file="config/configuration.yaml" doc:name="Configuration properties" />
----

== Migrating Global HTTP Listener Configuration

// Now do the same for the next migrated feature, and so on.

.Configuration XML for Global HTTP Listener Configuration in Studio 6.
[source,xml,linenums]
----
<http:listener-config name="HTTP_Listener_Configuration" host="${http.host}" port="${http.port}" doc:name="HTTP Listener Configuration"/>
----

// Explain what changed for Mule 4 in Studio 7, including any different modules, component you needed to use.
The minimal configuration requires specifying `host` and `port` in the inner `http:listener-connection` element. We use the placeholders defined in the previous step.

.Configuration XML for Global HTTP Listener Configuration in Studio 7.
[source,xml,linenums]
----
<http:listener-config name="httpListenerConfig">
  <http:listener-connection host="${http.host}" port="${http.port}" />
</http:listener-config>
----

== Migrating MySQL Global Configuration

// Now do the same for the next migrated feature, and so on.
The database connector facilitates setting up _Derby_, _MySQL_ and _Oracle_ databases for use in a Mule app.

. In the Mule Palette, click `Add Module` and select `Database Connector` among the available modules.
. Add a `Database Config` Global Configuration Element.
. In Database Config > Connection, select MySQL Connection.
. In MySQL JDBC Driver, click Add Dependency and configure the Maven information for the driver.
+
....
<dependency>
  <groupId>mysql</groupId>
  <artifactId>mysql-connector-java</artifactId>
  <version>5.1.6</version>
</dependency>
....
+
. Complete MySQL Global Configuration with `host`, `port`, `user`, `password` and `database` using previously defined placeholders.
+
.Configuration XML for MySQL Global Configuration in Studio 6.
[source,xml,linenums]
----
<db:mysql-config name="MySQL_Configuration" host="${mysql.host}" port="${mysql.port}" user="${mysql.user}" password="${mysql.password}" database="${mysql.database}" doc:name="MySQL Configuration" />
----
+
// Explain what changed for Mule 4 in Studio 7, including any different modules, component you needed to use.
+
.Configuration XML for MySQL Global Configuration in Studio 7.
[source,xml,linenums]
----
<db:config name="MySQL_Configuration" doc:name="Database Config">
  <db:my-sql-connection host="${mysql.host}" port="${mysql.port}" user="${mysql.user}" password="${mysql.password}" database="${mysql.database}" />
</db:config>
----

== Migrating API Auto-Discovery Configuration

// Now do the same for the next migrated feature, and so on.
The `api-platform-gw` global element is required for registering an API in Anypoint Platform.

.Configuration XML for API Auto-Discovery Configuration in Studio 6.
[source,xml,linenums]
----
<api-platform-gw:api apiName="${autodiscovery.api.name}" version="${autodiscovery.api.version}" flowRef="api-main" create="true" doc:name="API Autodiscovery"/>
----

// Explain what changed for Mule 4 in Studio 7, including any different modules, component you needed to use.
In Mule Runtime 4.x, the `apiName`, `version`, and `create` attributes were removed. Just the `apiId` and `flowRef` attributes are required. `apiId` is generated by API Manager and visible on the API instance dashboard.

For API Auto-Discovery Configuration in Mule Runtime 4.x:

. Add the following Namespace, Schema `global.xml` Configuration file.
+
....
xmlns:api-gateway="http://www.mulesoft.org/schema/mule/api-gateway"
http://www.mulesoft.org/schema/mule/api-gateway http://www.mulesoft.org/schema/mule/api-gateway/current/mule-api-gateway.xsd
....
+
. Add the required Auto-Discovery Dependency Information to project `pom.xml` file.
+
....
<dependency>
  <groupId>com.mulesoft.anypoint</groupId>
  <artifactId>mule-module-autodiscovery</artifactId>
  <version>4.0.0</version>
</dependency>
....
+
.Configuration XML for API Auto-Discovery Configuration in Studio 7.
[source,xml,linenums]
----
<api-gateway:autodiscovery apiId="${autodiscovery.api.id}" flowRef="api-product-main" doc:name="API Autodiscovery"/>
----

////
== Migrating Feature_2

// Now do the same for the next migrated feature, and so on.

.Configuration XML for Feature_1 in Studio 6.
[source,xml,linenums]
----
PASTE_XML_HERE
----

// Explain what changed for Mule 4 in Studio 7, including any different modules, component you needed to use.

.Configuration XML for Feature_1 in Studio 7.
[source,xml,linenums]
----
PASTE_XML_HERE
----
////

== See Also

link:migration-example-complex[Example: Migration to Mule 4]

link:migration-examples[Migration Examples]
