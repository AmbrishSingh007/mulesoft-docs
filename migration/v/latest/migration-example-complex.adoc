// Andres Alleva
= Example: Migration to Mule 4

////
This example migrates a Mule app to Mule 4 from Mule 3.
// Writer: Please explain the features or use cases you are going
// to cover. Provide a rationale, explaining how they worked
// in Mule 3 vs. how they work in Mule 4.

// You might list features in Mule 3 that you migrate to Mule 4,
// naming each feature, explaining how things changed in Mule 4,
// and anything about how it will work once migrated.

// * Feature 1
// * Feature 2
// * Feature etc.

// Before and After description: Please provide the big picture of what
// the app you are migrating looks like. Screenshots from in Studio 6 vs. // Studio 7 might be the most straightforward way to illustrate this.

//Optional: screenshot to store in migration/v/latest/_images
Here is a screenshot of this Mule app in Studio 6:

image::example1_complex_screenshot_here.png[App in Mule 3]

// Highlight the main differences between the examples.

//Optional: screenshot to store in migration/v/latest/_images
Here is the migrated app in Studio 7:

image::example2_complex_screenshot_here.png[App in Mule 4]

// If necessary or helpful, break down the migration into major steps,
// including any prep, for example:

This migration follows these basic steps:

. step 1
. step 2
. etc.

// Break down the app migration on a feature-by-feature basis.
////

== Migrating Property Placeholders

// Please replace this comment with an explanation
// of how you migrated the feature, and show the Studio 6
// vs. Studio 7 XML for the feature. Please provide any
// extra info needed to understand the changes to this feature
// in Mule 3 and Mule 4.
Mule 4 supports property placeholders either as `.yaml` or `.properties` configuration files.

. Create a folder with the name `config` under `/src/main/resources` project directory.
. Create a configuration file with the name `configuration.yaml` inside the newly created config folder.
. Migrate property placeholders from `.properties` to `.yaml` format.
+
.configuration.properties
----
http.host=0.0.0.0
http.port=8081

mysql.password=pa$$w0rd
mysql.port=3306
mysql.user=admin
mysql.database=products
mysql.host=corp.services.com

autodiscovery.api.version=1.0.0:1762946
autodiscovery.api.name=groupId:com.mulesoft.retailer.manufacturingit.apis:assetId:product-api-database

anypoint.platform.client_id=1f702j71hu9z2x88v9vd19v7h248s589
anypoint.platform.client_secret=87v8V47668701Dd574B0531255d6287d
----
+
.configuration.yaml
----
http:
  host: "0.0.0.0"
  port: "8081"

mysql:
  password: "pa$$w0rd"
  port: "3306"
  user: "admin"
  database: "products"
  host: "corp.services.com"

autodiscovery:
  api:
    name: "groupId:com.mulesoft.retailer.manufacturingit.apis:assetId:product-api-database"
    version: "1.0.0:1762946"

anypoint:
  platform:
    client_id: "1f702j71hu9z2x88v9vd19v7h248s589"
    client_secret: "87v8V47668701Dd574B0531255d6287d"
----
+
. Replace the standard Spring element `<context:property-placeholder>` with the new Global Element `configuration-properties`.
+
.Configuration XML for Property Placeholders in Studio 6.
[source,xml,linenums]
----
<context:property-placeholder location="configuration.properties" />
----
+
// Explain what changed for Mule 4 in Studio 7, including any different modules, component you needed to use.
The `file` attribute points to the new configuration file in YAML format located under `/src/main/resources/config` folder.
+
.Configuration XML for Property Placeholders in Studio 7.
[source,xml,linenums]
----
<configuration-properties file="config/configuration.yaml" doc:name="Configuration properties" />
----

== Migrating Global HTTP Listener Configuration

// Now do the same for the next migrated feature, and so on.

.Configuration XML for Global HTTP Listener Configuration in Studio 6.
[source,xml,linenums]
----
<http:listener-config name="HTTP_Listener_Configuration" host="${http.host}" port="${http.port}" doc:name="HTTP Listener Configuration"/>
----

// Explain what changed for Mule 4 in Studio 7, including any different modules, component you needed to use.
The minimal configuration requires specifying `host` and `port` in the inner `http:listener-connection` element. We use the placeholders defined in the previous step.

.Configuration XML for Global HTTP Listener Configuration in Studio 7.
[source,xml,linenums]
----
<http:listener-config name="httpListenerConfig">
  <http:listener-connection host="${http.host}" port="${http.port}" />
</http:listener-config>
----

== Migrating MySQL Global Configuration

// Now do the same for the next migrated feature, and so on.
The database connector facilitates setting up _Derby_, _MySQL_ and _Oracle_ databases for use in a Mule app.

. In the Mule Palette, click `Add Module` and select `Database Connector` among the available modules.
. Add a `Database Config` Global Configuration Element.
. In Database Config > Connection, select MySQL Connection.
. In MySQL JDBC Driver, click Add Dependency and configure the Maven information for the driver.
+
....
<dependency>
  <groupId>mysql</groupId>
  <artifactId>mysql-connector-java</artifactId>
  <version>5.1.6</version>
</dependency>
....
+
. Complete MySQL Global Configuration with `host`, `port`, `user`, `password` and `database` using previously defined placeholders.
+
.Configuration XML for MySQL Global Configuration in Studio 6.
[source,xml,linenums]
----
<db:mysql-config name="MySQL_Configuration" host="${mysql.host}" port="${mysql.port}" user="${mysql.user}" password="${mysql.password}" database="${mysql.database}" doc:name="MySQL Configuration" />
----
+
// Explain what changed for Mule 4 in Studio 7, including any different modules, component you needed to use.
+
.Configuration XML for MySQL Global Configuration in Studio 7.
[source,xml,linenums]
----
<db:config name="MySQL_Configuration" doc:name="Database Config">
  <db:my-sql-connection host="${mysql.host}" port="${mysql.port}" user="${mysql.user}" password="${mysql.password}" database="${mysql.database}" />
</db:config>
----

== Migrating API Auto-Discovery Configuration

// Now do the same for the next migrated feature, and so on.
The `api-platform-gw` global element is required for registering an API in Anypoint Platform.

.Configuration XML for API Auto-Discovery Configuration in Studio 6.
[source,xml,linenums]
----
<api-platform-gw:api apiName="${autodiscovery.api.name}" version="${autodiscovery.api.version}" flowRef="api-main" create="true" doc:name="API Autodiscovery"/>
----

// Explain what changed for Mule 4 in Studio 7, including any different modules, component you needed to use.
In Mule Runtime 4.x, the `apiName`, `version`, and `create` attributes were removed. Just the `apiId` and `flowRef` attributes are required. `apiId` is generated by API Manager and visible on the API instance dashboard.

For API Auto-Discovery Configuration in Mule Runtime 4.x:

. Add the following Namespace, Schema `global.xml` Configuration file.
+
....
xmlns:api-gateway="http://www.mulesoft.org/schema/mule/api-gateway"
http://www.mulesoft.org/schema/mule/api-gateway http://www.mulesoft.org/schema/mule/api-gateway/current/mule-api-gateway.xsd
....
+
. Add the required Auto-Discovery Dependency Information to project `pom.xml` file.
+
....
<dependency>
  <groupId>com.mulesoft.anypoint</groupId>
  <artifactId>mule-module-autodiscovery</artifactId>
  <version>4.0.0</version>
</dependency>
....
+
.Configuration XML for API Auto-Discovery Configuration in Studio 7.
[source,xml,linenums]
----
<api-gateway:autodiscovery apiId="${autodiscovery.api.id}" flowRef="api-product-main" doc:name="API Autodiscovery"/>
----

== Migrating _get-products-flow_

// Now do the same for the next migrated feature, and so on.
`get-products-flow` returns products from the database filtering by `Product Category` and/or `Product Name` also supporting paginated queries with `offset` and `maxResults` parameters.

.Configuration XML for get-products-flow in Studio 6.
[source,xml,linenums]
----
<flow name="get-products-flow">
  <message-properties-transformer doc:name="Get Query Params" scope="invocation">
    <add-message-property key="queryOffset" value="#[Integer.valueOf(message.inboundProperties.'http.query.params'.offset)]" />
    <add-message-property key="queryLimit" value="#[Integer.valueOf(message.inboundProperties.'http.query.params'.maxResults)]" />
    <add-message-property key="queryName" value="#[ (message.inboundProperties.'http.query.params'.name != null) ? ('%'+message.inboundProperties.'http.query.params'.name+'%') : '%%']" />
    <add-message-property key="queryCategory" value="#[ (message.inboundProperties.'http.query.params'.category != null) ? ('%'+message.inboundProperties.'http.query.params'.category+'%') : '%%']" />
  </message-properties-transformer>
  <db:select config-ref="MySQL_Configuration" doc:name="Query Products">
    <db:parameterized-query><![CDATA[SELECT  p.id, p.name, p.description, p.product_number, p.manufactured, p.colors, p.categories, p.stock, p.safety_stock_level, p.standard_cost, p.list_price, p.size, p.size_unit_measure_code, p.weight, p.weight_unit_measure_code, p.days_to_manufacture, p.images,  p.modified_date, p.created_date
FROM product p
WHERE LOWER(p.name) like #[flowVars.queryName.toLowerCase()] AND LOWER(p.categories) like #[flowVars.queryCategory.toLowerCase()]
LIMIT #[flowVars.queryLimit]
OFFSET #[flowVars.queryOffset]]]>
    </db:parameterized-query>
  </db:select>
  <dw:transform-message doc:name="Products to JSON">
    <dw:set-payload resource="classpath:mappings/get-products-response.dwl"/>
  </dw:transform-message>
</flow>
----

// Explain what changed for Mule 4 in Studio 7, including any different modules, component you needed to use.
. There are no changes regarding `get-products-flow` definition.
+

[source,xml,linenums]
----
<flow name="get-products-flow">
----

. Add a `Transform component` to replace the logic inside `message-properties-transformer` and set the variables `queryOffset`, `queryLimit`, `queryName` and `queryCategory` with the values received as `query-parameters`.
. Due to new Mule Message Structure notice how the old expression `inboundProperties."http.query.params".offset` should be rewritten as `attributes.queryParams.offset` for accessing `query-parameters`.
+

[source,xml,linenums]
----
<ee:transform doc:name="Get Query Params">
  <ee:message />
    <ee:variables>
      <ee:set-variable variableName="queryOffset"><![CDATA[%dw 2.0
output application/java
---
attributes.queryParams.offset as Number]]></ee:set-variable>
      <ee:set-variable variableName="queryLimit"><![CDATA[%dw 2.0
output application/java
---
attributes.queryParams.maxResults as Number]]></ee:set-variable>
      <ee:set-variable variableName="queryName"><![CDATA[%dw 2.0
output application/java
var queryName = attributes.queryParams.name
---
if (queryName != null)
	queryName
else
	'%%']]></ee:set-variable>
      <ee:set-variable variableName="queryCategory"><![CDATA[%dw 2.0
output application/java
var queryCategory = attributes.queryParams.category
---
if (queryCategory != null)
	queryCategory
else
	'%%']]></ee:set-variable>
  </ee:variables>
</ee:transform>
----

. Add a `db:select` element, referencing the MySQL Global Configuration. Use the colon (:) syntax in parametrized queries. Parameters must be supplied as key-value pairs into the `db:input-parameters` element.
+

[source,xml,linenums]
----
<db:select config-ref="MySQL_Configuration" doc:name="Query Products">
  <db:sql >SELECT  p.id, p.name, p.description, p.product_number, p.manufactured, p.colors, p.categories, p.stock, p.safety_stock_level, p.standard_cost, p.list_price, p.size, p.size_unit_measure_code, p.weight, p.weight_unit_measure_code, p.days_to_manufacture, p.images,  p.modified_date, p.created_date
FROM product p
WHERE LOWER(p.name) like :name AND LOWER(p.categories) like :category
LIMIT :limit
OFFSET :offset</db:sql>
  <db:input-parameters ><![CDATA[#[{'name' : lower(vars.queryName), 'category': lower(vars.queryCategory), 'limit': vars.queryLimit, 'offset': vars.queryOffset}]]]></db:input-parameters>
</db:select>
----

. Migrate `get-products-response.dwl` DW 1.0 script to DW 2.0.
+

.Transformation for get-products-response in DW 1.0.
----
%dw 1.0
%output application/json
---
payload map {
	id: $.id,
	categories: ($.categories default "") splitBy ",",
	colors: ($.colors default "") splitBy ",",
	images: ($.images default "") splitBy ",",
	createdDate: $.created_date as :string {format: "yyyy-MM-dd"},
	modifiedDate: $.modified_date as :string {format: "yyyy-MM-dd"},
	safetyStockLevel: $.safety_stock_level as :number,
	stock: $.stock as :number,
	daysToManufacture: $.days_to_manufacture,
	name: $.name,
	description: $.description,
	listPrice: $.list_price,
	manufactured: $.manufactured,
	productNumber: $.product_number,
	size: $.size,
	sizeUnitMeasureCode: $.size_unit_measure_code,
	standardCost: $.standard_cost,
	weightUnitMeasureCode: $.weight_unit_measure_code,
	weight: $.weight
}
----

.Transformation for get-products-response in DW 2.0.
----
%dw 2.0
output application/json
---
payload map {
	id: $.id,
	categories: ($.categories default "") splitBy ",",
	colors: ($.colors default "") splitBy ",",
	images: ($.images default "") splitBy ",",
	createdDate: $.created_date as String {format: "yyyy-MM-dd"},
	modifiedDate: $.modified_date as String {format: "yyyy-MM-dd"},
	safetyStockLevel: $.safety_stock_level as Number,
	stock: $.stock as Number,
	daysToManufacture: $.days_to_manufacture,
	name: $.name,
	description: $.description,
	listPrice: $.list_price,
	manufactured: $.manufactured,
	productNumber: $.product_number,
	size: $.size,
	sizeUnitMeasureCode: $.size_unit_measure_code,
	standardCost: $.standard_cost,
	weightUnitMeasureCode: $.weight_unit_measure_code,
	weight: $.weight
}
----

.Configuration XML for get-products-flow in Studio 7.
[source,xml,linenums]
----
<flow name="get-products-flow">
	<ee:transform doc:name="Get Query Params">
    <ee:message />
    <ee:variables>
      <ee:set-variable variableName="queryOffset"><![CDATA[%dw 2.0
output application/java
---
attributes.queryParams.offset as Number]]></ee:set-variable>
      <ee:set-variable variableName="queryLimit"><![CDATA[%dw 2.0
output application/java
---
attributes.queryParams.maxResults as Number]]></ee:set-variable>
      <ee:set-variable variableName="queryName"><![CDATA[%dw 2.0
output application/java
var queryName = attributes.queryParams.name
---
if (queryName != null)
	queryName
else
	'%%']]></ee:set-variable>
      <ee:set-variable variableName="queryCategory"><![CDATA[%dw 2.0
output application/java
var queryCategory = attributes.queryParams.category
---
if (queryCategory != null)
	queryCategory
else
	'%%']]></ee:set-variable>
    </ee:variables>
  </ee:transform>
  <db:select config-ref="MySQL_Configuration" doc:name="Query Products">
    <db:sql>SELECT p.id, p.name, p.description, p.product_number,
				p.manufactured, p.colors, p.categories, p.stock,
				p.safety_stock_level, p.standard_cost, p.list_price, p.size,
				p.size_unit_measure_code, p.weight, p.weight_unit_measure_code,
				p.days_to_manufacture, p.images, p.modified_date, p.created_date
				FROM product p
				WHERE LOWER(p.name) like :name AND LOWER(p.categories) like :category
				LIMIT :limit
				OFFSET :offset</db:sql>
    <db:input-parameters><![CDATA[#[{'name' : lower(vars.queryName), 'category': lower(vars.queryCategory), 'limit': vars.queryLimit, 'offset': vars.queryOffset}]]]></db:input-parameters>
  </db:select>
	<ee:transform doc:name="Products to JSON">
    <ee:message>
      <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map {
	id: $.id,
	categories: ($.categories default "") splitBy ",",
	colors: ($.colors default "") splitBy ",",
	images: ($.images default "") splitBy ",",
	createdDate: $.created_date as String {format: "yyyy-MM-dd"},
	modifiedDate: $.modified_date as String {format: "yyyy-MM-dd"},
	safetyStockLevel: $.safety_stock_level as Number,
	stock: $.stock as Number,
	daysToManufacture: $.days_to_manufacture,
	name: $.name,
	description: $.description,
	listPrice: $.list_price,
	manufactured: $.manufactured,
	productNumber: $.product_number,
	size: $.size,
	sizeUnitMeasureCode: $.size_unit_measure_code,
	standardCost: $.standard_cost,
	weightUnitMeasureCode: $.weight_unit_measure_code,
	weight: $.weight
}]]></ee:set-payload>
    </ee:message>
  </ee:transform>
</flow>
----

== Migrating _delete-product-flow_

// Now do the same for the next migrated feature, and so on.
`delete-product-flow` deletes the product record from the MySQL database with the `id` specified as a `URI parameter` returning an HTTP 204 status code.

.Configuration XML for delete-product-flow in Studio 6.
[source,xml,linenums]
----
<flow name="delete-product-flow">
  <transactional action="ALWAYS_BEGIN" doc:name="Transactional">
    <db:delete config-ref="MySQL_Configuration" doc:name="Delete Product">
      <db:parameterized-query><![CDATA[delete from product where id=#[id]]]></db:parameterized-query>
    </db:delete>
  </transactional>
  <set-payload value="#[NullPayload.getInstance()]" doc:name="Set Payload"/>
  <set-property propertyName="http.status" value="204" doc:name="Set Status"/>
</flow>
----

// Explain what changed for Mule 4 in Studio 7, including any different modules, component you needed to use.
. There are no changes regarding `delete-product-flow` definition.
+

[source,xml,linenums]
----
<flow name="delete-product-flow" />
----

. As `Dataweave 2.0` is the default `Mule Runtime 4.x` expression language, add a `Transform component` for writing a DW script that sets a variable with the `productId` value received as a `URI parameter`.
+

[source,xml,linenums]
----
<ee:transform doc:name="Set productId variable">
  <ee:message />
  <ee:variables>
    <ee:set-variable variableName="productId" ><![CDATA[%dw 2.0
output application/java
---
attributes.uriParams.id]]>
    </ee:set-variable>
  </ee:variables>
</ee:transform>
----

. For configuring the details of the transaction, replace the Mule 3.x `transactional` scope with the new `try` scope and set the `transactionalAction` attribute to `ALWAYS_BEGIN`.
+

[source,xml,linenums]
----
<try doc:name="Try" transactionalAction="ALWAYS_BEGIN">
</try>
----

. Add a `db:delete` element into the `Try scope`, referencing the MySQL Global Configuration. Parameters must be supplied as key-value pairs into the `db:input-parameters` element. Opposite to Mule 3.x, the previously defined `productId` flow variable must be accessed as `vars.productId` instead of `flowVars.productId`.
+

[source,xml,linenums]
----
<try doc:name="Try" transactionalAction="ALWAYS_BEGIN">
  <db:delete config-ref="MySQL_Configuration" doc:name="Delete Product">
    <db:sql>delete from product where id=:productId</db:sql>
    <db:input-parameters><![CDATA[#[{'productId' : vars.productId}]]]></db:input-parameters>
  </db:delete>
</try>
----

. Set `httpStatus` variable with the value `204` using a `Transform Component` for defining a `NO CONTENT` response code.
+

[source,xml,linenums]
----
<ee:transform doc:name="Set Status" doc:id="a96f6930-5f34-4f03-8ad6-766ed77dc615">
  <ee:message />
  <ee:variables>
    <ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
204]]></ee:set-variable>
  </ee:variables>
</ee:transform>
----

.Configuration XML for delete-product-flow in Studio 7.
[source,xml,linenums]
----
<flow name="delete-product-flow">
  <ee:transform doc:name="Set productId variable">
    <ee:message />
    <ee:variables>
      <ee:set-variable variableName="productId" ><![CDATA[%dw 2.0
output application/java
---
attributes.uriParams.id]]>
      </ee:set-variable>
    </ee:variables>
  </ee:transform>
  <try doc:name="Try" transactionalAction="ALWAYS_BEGIN">
    <db:delete config-ref="MySQL_Configuration" doc:name="Delete Product">
      <db:sql>delete from product where id=:productId</db:sql>
      <db:input-parameters><![CDATA[#[{'productId' : vars.productId}]]]></db:input-parameters>
    </db:delete>
  </try>
  <ee:transform doc:name="Set Status" doc:id="a96f6930-5f34-4f03-8ad6-766ed77dc615">
    <ee:message />
      <ee:variables>
        <ee:set-variable variableName="httpStatus"><![CDATA[%dw 2.0
output application/java
---
204]]></ee:set-variable>
    </ee:variables>
  </ee:transform>
</flow>
----

////
== Migrating Feature_2

// Now do the same for the next migrated feature, and so on.

.Configuration XML for Feature_1 in Studio 6.
[source,xml,linenums]
----
PASTE_XML_HERE
----

// Explain what changed for Mule 4 in Studio 7, including any different modules, component you needed to use.

.Configuration XML for Feature_1 in Studio 7.
[source,xml,linenums]
----
PASTE_XML_HERE
----
////

== See Also

link:migration-example-complex[Example: Migration to Mule 4]

link:migration-examples[Migration Examples]
