= Install Runtime Fabric on Azure

This topic describes how to install and register Anypoint Runtime Fabric on your Azure account.

[WARNING]
====
Before running the installer, ensure that your infrastructure meets the minimum hardware requirements. An operations specialist may be needed to provision the required infrastructure.
====

== Download Installer
The installer package includes the necessary scripts and binaries needed to install Runtime Fabric.

. Log in to Anypoint platform and navigate to Runtime Manager.
. On the left navigation pane, select "Runtime Fabrics".
. Click "Create Runtime Fabric".
. Click the installer link to begin the download.
. Once downloaded, unpack the installer file to view its contents.

[NOTE]
The extension for the installer is packaged as `tar.gz`. You'll need a utility to unpack tar files.

You'll find a directory named `azure` inside the installer, which contains the following:

* `resource-template.json`: the Azure Resource Template used to provision infrastructure on your Azure account.
* `auto_installer.py`: the installation bootstrap script.
* `resources/`: a directory containing the scripts ran automatically per VM provisioned with the included Azure Resource Template, for reference.
* `README.md`: a markdown file containing instructions to install on Azure.

== Provision Infrastructure
Use the included Azure Resource Manager Template to easily provision the required hardware and network settings needed to install and operate Runtime Fabric.

There are multiple methods to apply the Azure Resource Manager Template to your Azure account. Below are instructions to apply the template via the Azure Portal.

[NOTE]
You'll need a private and public key as a PEM file to provision the VMs. This is required to enable secure access to your VMs via SSH (Secure Shell).

. Log into your Azure account.
. Navigate to "Create a resource".
. On the "Search the marketplace" search bar, type in "Template deployment".
. Click "Create".
. Select "Build your own template in the editor."
. On the bar above the editor, click "Load file" and select the `resource-template.json`.
. After the editor is populated with the contents of the file, click "Save".
. Verify your Subscription selection, Resource group, and Region for deployment. In most cases, it's recommended to create a separate Resource group.
. Under Settings, fill in the `Public_keys_data` field with your public key string. This will enable you to SSH into each VM with your associated private key.
. Review and select the Terms and Conditions on the bottom of the page, and click "Purchase".

Your infrastructure will begin be created and configured. Follow these steps to view the progress:

. On the left navigtion bar, click on "Resource groups".
. Select the Resource group used to provision your Runtime Fabric infrastructure. 
. On the Overview pane under Deployments, click on the link below, which may read "1 Deploying".
. Click on the Deployment Name "Microsoft.Template".

You should be able to see the list of infrastructure and its cooresponding status as it's being provisioned. Click the "Refresh" button to periodicaly refresh the pane and status.

=== Common errors
Depending on the policies set and the quotas defined with your Azure account, you may encounter errors during the provisioning process. Consult your operations team as needed.

* Exceed max core quota: File a ticket with Azure Support to increase quota for your deployment region.
* Network policy violation: By defualt, the Netowrk Security Groups defined in the Azure Resource Template are associated at the subnet level and the NIC for each VM. Depending on your company's policy, you may need to adjust the template to remove an association.

== Install Runtime Fabric

After the required infrastructure has been provisioned successfully, you can now begin the installation process.

. Connect to the `rtf-controller-1` VM using your preferred SSH utility. You may need to reference your private key cooresponding to the public key provided during the provisioning process.
+
----
ssh rtf-user@<PUBLIC-IP-ADDRESS> -i <private_key.pem>
----
+
. Change directory to the tmp directory.
+
----
cd /tmp
----
+
. 



Step 1: Provision infrastructure
Run script to provision infrastructure, based on the Flavors above
Can be Azure Resource Template (early testing confirms Azure customers are fluent with this)
Can be Terraform
Supported configured fields:
Remove Public IPs from VMs
Adjust Network Security Group binding to NIC and/or VM
Machine Images
Disk space for all block devices (increase)
Machine types (increase only)
Step 2: Run the installer
Mount and format block devices
