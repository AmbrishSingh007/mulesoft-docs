= SAP Concur Connector
:keywords: concur connector, user guide, user manual
:imagesdir: ./_images

_Select_

SAP Concur is a SaaS provider from SAP for integrated travel and expense management solutions.

Anypoint Connector for Concur operates as a bi-directional gateway between instances of Concur and Mule. It is a closed-source connector that supports SOAP and REST calls to various Concur APIs.

== Prerequisites

This document assumes that you are familiar with Mule, Anypoint Connectors, Anypoint Studio, Mule concepts, elements in a Mule flow, and Global Elements.

You need login credentials to test your connection to your target resource.

For hardware and software requirements and compatibility
information, see the Connector Release Notes.

To use this connector with Maven, view the pom.xml dependency information in
the Dependency Snippets in Anypoint Exchange.

== To Connect in Design Center

. In Design Center, click Set Up > Upload, browse for and select the driver for this connector on your file system, and upload it. Alternatively, search for and select a driver that is already uploaded.
. Click a trigger. You can create a global element by selecting this connector as their trigger.
If a global element is not needed, you can use an HTTP Listener or Scheduler trigger.
+
image:sap-concur-trigger.png[Trigger options]
+
. To create an HTTP global element for the connector, set these fields:
+
image:sap-concur-http-listener.png[Http Listener configuration]
+
[%header%autowidth.spread]
|===
|Field |Description
|Protocol | Protocol selected for the HTTP endpoint, it can be HTTP or HTTPS (secure).
|Host| IP address where your Mule application listens for requests.
|Port| Port address where your Mule application listens for requests.
|Base| Path where your Mule application listens for requests.
|===
+
. Select the plus sign to add a component.
+
image:sap-concur-plus-sign.png[add connector]
+
. Select the connector as a component.
. Select an operation (see the next section for a list of operations).
. Configure the Global element for the connector.
+
image:sap-concur-config-design.png[config connector]
+
[%header%autowidth]
|===
|Field |Description
|Host | Enter the host name of the Concur connector.
|Port | Enter the port on which the Concur connector is running. Default value is 443.
|Base Path | Path where your Mule application listens for requests.
|Protocol |Protocol selected for the http endpoint, it can be http or https (secure).
|Authorization| A Concur access token.
|===

== About the Operations

image:sap-concur-operations-design.png[operations Connector]
+
[%header%autowidth.spread]
|===
|Operation | Description
|Approve a trip | Approve a trip
|Close a payment batch | This request closes the specified batch, preventing any new expenses from entering it.
|Create a Report Exception | Posts an exception to the report, and associates it with one of the following data levels: Report Header, Entry, Itemization, Allocation. This endpoint 
requires familiarity with the companyâ€™s exception code configuration.
|Create an Attendee | Create a new attendee.
|Create an Attendee Type | Creates a new attendee type.
|Create an Entry Attendee Association | Creates a new entry-attendee association.
|Create an Expense Entry | Create a new expense entry.
|Create an Expense Itemization | Creates a new expense itemization.
|Create an Expense Receipt Image | Create a new receipt image.
|Create an Expense Report | Create a new report.
|Create Expense Reports | Posts a batch of expense report headers. The expense report header contains classification information for the expense report.
|Create or update users with batch of user profiles | Create or update users with batch of user profiles.
|Create quick expense | Create a quick expense.
|Delete Attendee Type | Deletes the specified attendee type.
|Delete Entry Attendee Association | Deletes the specified entry-attendee association.
|Get a QuickExpense | Get a QuickExpense by its ID.
|Get a Receipt Image | Get a Receipt Image.
|Get a single expense entry | Get a single expense entry
|Get a travel profile | Provides travel profile information for the specified user.
|Get all requests | Get list of travel requests.
|Get Allocations | Get all allocations.
|Get an Allocation | Get an allocation.
|Get an attendee | Get an attendee.
|Get Attendee Type | Gets an attendee type by ID.
|Get Attendee Types | Gets all active attendee types for the company.
|Get attendees | Get all attendees.
|Get Card Charges | This request returns a CardCharges parent element with a CardCharge child element for each transaction.
|Get Entry Attendee Association | Gets an entry-attendee association by ID.
|Get Entry Attendee Associations | Gets all entry-attendee associations owned by the user. These are the associations between an expense entry and an attendee.
|Get Expense delegators | Retrieves the list of users that have granted delegate permissions to the user specified in the OAuth access token.
|Get expense entries | Get all expense entries.
|Get Expense Group Configuration | Gets the configuration of an expense group.
|Get Expense Itemization | Retrieve an expense itemization by ID.
|Get Expense Itemizations | Gets all expense itemizations owned by the user.
|Get Expense Report | Get an Expense Report
|Get Form Data | Retrieves the list of configured forms for the specified form type.
|Get Form Fields | Retrieves the details of the configured form fields for the specified form.
|Get Form Types | Retrieves the list of users that have granted delegate permissions to the user specified in the OAuth access token.
|Get Global Form Fields | Retrieves a list of configured fields on the Global employee form in Concur.
|Get Itinerary Details | Get itinerary details.
|Get List Details | Retrieves the list details for a specified list. Includes configuration information, not the list items.
|GET List Items | Retrieves the list items for the specified list.
|Get List of Itineraries | Retrieve the List of itineraries.
|Get List of Lists | Returns a lists parent element containing a list child element for each configured list.
|Get Payment Batches |  Retrieves the list of payment batches with an optional requested status.
|Get quick expenses | Retrieve all quick expenses.
|Get reports | Gets all reports
|Get Tax Invoices | Retrieves all digital tax invoices that can be validated by the user based on the search criteria.
|Get the list of forms of payment | Provides the list of forms of payment.
|Get the list of updated travel profiles | Provides a list of travel profile summaries that have been updated since the specified date.
|Get User Profile | Retrieve the user profile.
|Make Batch updates to List Items | Adds list items to an existing list.
|Make updates to the loyalty programs | Updates the loyalty program information for the OAuth consumer.
|Put Expense Report | Updates report specified in the URL. Only the fields provided in the supplied object are updated, missing fields are not altered.
|Update an expense entry | Updates the specified expense entry. Only the fields provided in the supplied object are updated. Missing fields are not altered.
|Update Attendee Type | Updates the specified attendee type. Only the fields provided in the supplied object are updated. Missing fields are not altered.
|Update Entry Attendee Association | Updates the specified entry-attendee association. Only the fields provided in the supplied object are updated. Missing fields are not altered.
|Update Expense Itemization | Updates the specified expense itemization. Only the fields provided in the supplied object are updated. Missing fields are not altered.
|Update Users Password | This resource allows you to update passwords for up to 500 users.
|Updates a quick expense | Updates a quick expense.
|===

== About Concur API Availability

The sections that follow list how much support this connector provides for the SAP 
Concur web service REST functions.

=== Attendees

Manage and retrieve attendee information using this Concur web service, comprising the following APIs, two of which are fully supported.

* Attendee List: POST
** This API is fully supported under Batch Attendee List. All Attendee List
operations are managed in batches (including, for example, a batch of one), with a supplied Batch Type parameter determining if the batch should be CREATE-ed or UPDATE-ed. Batches have a maximum size of 1000, and
anything above a size 1000 is ignored. The connector throws an exception if a batch of size > 1000 items is submitted.

* Attendee: GET
** Fully supported as GET Attendee Details endpoint.

* Attendee Type: GET
** Fully supported.

=== Expenses

Posting expense report information is a multi-stage process. Refer to
the Expense Report Resource page (in the See Also section of this document) for the
steps required to post new expense reports and entries. Note that v1.1
APIs use different API formats from v2.0 APIs, and translation may be
required. An ID for a v1.1 API is of the format
`nOlmsYX2xcsvI7blatexmath:[$p$]snbhLUZq19M7jxRtk`, whereas a 2.0 ID uses
a shorter ID without special characters, in the format
`425FE2ADB4954FCA90CD`. Unfortunately, APIs are not available in both
versions, so the user should be aware of this behavior.

* Expense Entry Attendee: GET
** Fully Supported.

* Expense Entry Attendee: POST
** v1.1 of this API is supported, and operates in a Batch.

* Expense Entry: GET
** Get Expense Entry Details is supported, but note that Report and Entry
ID fields returned from some APIs are not completely compatible across
endpoints. Concur's behavior is inconsistent in this area, for example
URI Source: The reportId value is returned in the RptKey element and
the entryId value is returned in the RpeKey element by the function Get
Full Report Details v1.1. The full URL is provided within the itemurl
query string for the Request for the Launch External URL callout, and in
the Report-Entry-Details-Url element by the Post Expense Entry function
response. Do not expect a Report ID from one Web Service to work with
another unless the documentation specifically states so. A link for more
information on Get Expense Entry Details is provided in the 
See Also section of this document.

* Expense Entry: POST
** Posts an expense entry for a given report, after a report header has
been created. EntryID is optional, and is only required when a specific
entry must be updated.
+
Note: Concur recommends that you post one expense entry per request.
+
* Expense Report Header: POST
** This API works in both single header (post Expense Report Header) and
batch (post Expense Report Header Batch) modes. Report ID is only needed
when updating an existing report. Note that the input types are
different for single headers versus batches.

* Expense Report: GET
** V2.0 of this API is supported. GET List of Reports is supported, with a
large number of (all optional) search filters as parameters. GET Report
Details is supported, but may have inconsistent behavior based on the
Concur instance configuration, for example. 
+
Some elements appear only
if the OAuth consumer has the Web Services Admin role. These include:
The ReportKey element, the employee's credit card information, and the
employee's bank account information, VAT information, Journal entries.
The Mule Connector does not support any of these items, as it has not
been reviewed by Concur for security.

* Expense Report: POST
** Expense Report Submit is supported. Expense Report Workflow actions are not supported at this
time.

=== Extract

Extracts are not available in the Mule Connector, as they are an
alternative integration means. There are no plans to support this
resource.

=== Image

The imaging v3.0 APIs are mostly supported in JSON mode. PUT and DELETE
Operations are not supported at this time as during development the
endpoints did not work as documented. Once the APIs are functional they
may be supported.

=== Itinerary

Itineraries are only partially supported. POST Itinerary Cancellations
do not return valid XML, and therefore cannot be parsed and thus are not
supported. Other API endpoints are supported as documented.

=== Bookings

Bookings are only partially supported. POST Booking Cancellations
returns HTTP 404, and therefore cannot be parsed and thus are not
supported. Other API endpoints are supported as documented.

* Itinerary: GET
** All APIs are supported: Get List of Itineraries, Get Itinerary Details

* Booking: POST
** The bookings endpoints are not currently supported.

* Itinerary: POST
** POST operations are not supported for Itineraries at this time.

=== List Items

* List: GET
** All APIs are supported: Get List of Lists, Get List Details, Get List
Items.

* List: POST
** List updates are managed in batches, with a batch type parameter
determining if the list change is Create, Update, or Delete. Batch
limits are not discussed or tested, but it is safe to assume that
batches must be less than 1000 or they are ignored, as with other batch
API endpoints.

=== Meeting

Meeting endpoints are only supported in Travel for Concur
Professional or Premium. These APIs are not supported by the Anypoint Concur
Connector.

=== Payment Batch File

GET List of Payment Batches is supported, with an optional status filter
parameter. POST Payment Batch Close is also supported, requiring the
appropriate BatchID to be supplied.

=== Purchase Order Web Service

Purchase Order endpoints are only supported in Invoice for Concur
Professional/Premium. These APIs are not supported by the Mule
Connector.

=== Quick Expenses

Quick Expense v3.0 APIs are supported, using JSON as the interchange
format. All endpoints are supported: GET all quickexpenses, GET
QuickExpense by ID, Create a new QuickExpense (POST), Update a
QuickExpense by ID (PUT), and DELETE a QuickExpense by ID.

=== Travel Request

Travel Requests are only partially supported, as an integrator must
partner with Concur as an appropriate organization type (for example, a Travel
Agency). Without the ability to create a travel request, an
ID cannot be fetched, so GET Travel Request Details is not supported,
nor is POST Travel Request Workflow Action. GET List of Travel Requests
is supported, however.


=== Travel Profile

Travel Profile APIs are fully supported.


=== Trip Approval

POST Trip Approval (the only API) is supported. This updates a Trip
Approval as either approved or rejected.

=== User

* GET Employee Form Field
** Get List of Employee Form Fields is supported.

* User: GET
** Get User Information is fully supported.

* User: POST
** POST New or Updated users is fully supported. The batch can only support up
to 500 users.

* User Password: POST
** Updates passwords for up to 500 users.


=== TripIt from Concur

TripIt from Concur has not been considered in building the Mule
Connector for Concur.

=== Developer Preview APIs

There are some APIs which are considered Developer Previews. Connector
support for these has not been added at this time due to the likelihood
of significant API changes.

=== Callouts

Callouts are not available in the Concur connector. They
require extensive specific configuration and cannot be easily
genericized. Using the standard endpoint tools available in Mule,
you can integrate callouts, but a connector cannot assist here.

== Connect in Anypoint Studio 7

You can use this connector in Anypoint Studio by adding it as a dependency in your Mule application.

=== Install Connector in Studio

. Open your Mule project in Anypoint Studio.
. Add the connector as a dependency in the pom.xml file:
+
[source, linenums]
----
<dependency>
  <groupId>org.mule.modules</groupId>
  <artifactId>mule-module-concur</artifactId>
  <version>4.0.3</version>
  <classifier>mule-plugin</classifier>
</dependency>
----

== Example Use Case

This guide presents two of many use cases you might have for the Concur connector in your organization: getting a list of lists and retrieving quickexpenses. You may jump ahead and paste the code for the flows into the XML Editor in Studio after you download the Concur connector and create a global element to reference your Concur instance credentials.

=== Retrieve a List of Lists

After creating a new project and a Concur global element:

. Add a new flow element by dragging it from the palette and give a name to the flow, such as `getlists`.
. Drag an HTTP Listener into your flow from the palette.
. Double-click the HTTP Listener and click the green plus sign next to the Connector Configuration dropdown and set the Host to localhost, and the Port to 8081.
. Click OK to close the properties window, then enter getlists as the value in the Path field in this HTTP listener's Basic Settings section.
. Add a Concur connector to the new flow and select the Get list of lists operation, after selecting the Connector Configuration you desire.
. Finally, add a Transform Message transformer to the flow.
. For reference you may check the particular getlists flow within the example XML code further down.

To execute the flow and check the outcome:

. Right-click the project in the Package Explorer, and click Run As > Mule Application.
. Check that the application has started by monitoring the Studio console.
. Open browser and go to `+http://localhost:8081/getlist+`
. You should receive a JSON response like this:
+
[source,json,linenums]
----
{"list":[{"batchLink":"https://www.concursolutions.com/api/expense/list/v1.0/gWqXO46r6GsRt9CeqUjOAfZXRTmGyyVczqg/batch","id":"https://www.concursolutions.com/api/expense/list/v1.0/gWqXO46r6GsRt9CeqUjOAfZXRTmGyyVczqg","isVendor":false,"itemsLink":"https://www.concursolutions.com/api/expense/list/v1.0/gWqXO46r6GsRt9CeqUjOAfZXRTmGyyVczqg/items","levels":1,"name":"AT Tax Form List 1"},
{"batchLink":"https://www.concursolutions.com/api/expense/list/v1.0/gWqXO46r6GsRsUIXmIbg3iUc6qE9AlKEVxA/batch","id":"https://www.concursolutions.com/api/expense/list/v1.0/gWqXO46r6GsRsUIXmIbg3iUc6qE9AlKEVxA","isVendor":false,"itemsLink":"https://www.concursolutions.com/api/expense/list/v1.0/gWqXO46r6GsRsUIXmIbg3iUc6qE9AlKEVxA/items","levels":1,"name":"BE Tax Form List 1"},
{"batchLink":"https://www.concursolutions.com/api/expense/list/v1.0/gWqXO46r6GscWDPncbQqGUoCjCv4pxrnp2A/batch","id":"https://www.concursolutions.com/api/expense/list/v1.0/gWqXO46r6GscWDPncbQqGUoCjCv4pxrnp2A","isVendor":false,"itemsLink":"https://www.concursolutions.com/api/expense/list/v1.0/gWqXO46r6GscWDPncbQqGUoCjCv4pxrnp2A/items","levels":1,"name":"CH Tax Form List 1"}
----
+
. Click the stop button to halt the server running the application.

=== Create a Quick Expense

. Add a new flow element by dragging it from the palette and name it getquickexpenses.
. Add an HTTP Listener to your flow by dragging it from the palette.
. Use the configuration from the first demo, or if you did not create that flow, click the green plus sign next to Connector Configuration for the HTTP endpoint and enter localhost as the Host and 8081 for the Port.
+
. Click OK to close the properties window, then enter getquickexpenses as the value in the Path field in this HTTP listener's Basic Settings section.

. Add the Concur connector to the new flow, referencing a global element from the Connector Configuration and set an Operation to perform and any other properties you require.
. Finally, add an Transform Message transformer link in the previous example.

To execute the flow and check the outcome, perform the following steps:

. Right-click on the project in the Package Explorer > Run As > Mule Application
. Check the console to see when the application starts.
. Open the browser and go to `+http://localhost:8081/getquickexpenses+`
. You should receive a JSON response like this:
+
[source,json,linenums]
----
{"items":{"quickExpense":[{"comment":"","currencyCode":"USD","expenseTypeCode":"UNDEF","expenseTypeName":"Undefined","id":"gWr7TiTHdIi5fyWCPBRPtqjeCIWyv2w","locationName":"","ownerLoginID":"","ownerName":"Unknown","paymentTypeCode":"PENDC","receiptImageID":"","transactionAmount":111.0,"transactionDate":"2018-07-21T00:00:00","uri":"https://www.concursolutions.com/api/v3.0/expense/quickexpenses/gWr7TiTHdIi5fyWCPBRPtqjeCIWyv2w","vendorDescription":""},
{"comment":"","currencyCode":"USD","expenseTypeCode":"UNDEF","expenseTypeName":"Undefined","id":"gWr7TiTXbQ47PtJ$pVkr6CzbLeRVRPww","locationName":"","ownerLoginID":"","ownerName":"Unknown","paymentTypeCode":"PENDC","receiptImageID":"","transactionAmount":111.0,"transactionDate":"2018-07-21T00:00:00","uri":"https://www.concursolutions.com/api/v3.0/expense/quickexpenses/gWr7TiTXbQ47PtJ$pVkr6CzbLeRVRPww","vendorDescription":""},
----
+
. Click the stop button to halt the server running the application.

== See Also

* https://www.concur.com[Concur].
* https://developer.concur.com/api-reference/expense/expense-report/reports.html[Expense Report Resource page].
* https://developer.concur.com/api-reference-deprecated/version-one-one/expense-entry/get-expense-entry.html[Get Expense Entry Details].
